<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<title>캠페인 조회</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/common/css/styles.css" th:href="@{/common/css/styles.css}" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<style>
 	/* The Modal (background) */
	.modal {
		display: none; /* Hidden by default */
    	position: fixed; /* Stay in place */
    	z-index: 9999; /* Sit on top */
    	left: 0;
    	top: 0;
    	width: 100%; /* Full width */
    	height: 100%; /* Full height */
    	overflow: auto; /* Enable scroll if needed */
    	background-color: rgb(0,0,0); /* Fallback color */
    	background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}
    
    /* Modal Content/Box */
    .modal-content {
    	background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 50%; /* Could be more or less, depending on screen size */                          
    }
    
    /* The Close Button */
    .close {
       color: #aaa;
       float: right;
       font-size: 28px;
       font-weight: bold;
    }
    
    .close:hover,
    .close:focus {
    	color: black;
        text-decoration: none;
        cursor: pointer;
    }    
</style>

<!-- Alertyfy.js -->
<script   src="//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/alertify.min.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/css/alertify.min.css" />
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.4/build/css/themes/default.min.css" />

</head>

<body>
	<div id="wrap" class="main">
		<div th:replace="/include/header.html :: header"></div>
		<!-- 본문 영역 Start -->

		<div style="float: left; width: 70%">
			<input type="hidden" id="campaignId" th:value="${campaign.campaignId}">
			<h4 th:text="${campaign.title}" style="margin-top: 10%;"></h4>
			<th:block th:if="${session[advertisementvo] != null}">
			<a th:if="${session['advertisementvo'].advertisementId} == ${campaign.advertisementvo.advertisementId}" th:href="@{updateCampaign(campaignId=${campaign.campaignId})}">수정하기 </a>
			<p th:if="${session['advertisementvo'].advertisementId} == ${campaign.advertisementvo.advertisementId}" id="deleteTxt">삭제하기</p>

			</th:block>
			<th:block th:each="campaignImg:${campaignImgList}">
				<img th:src="${campaignImg.campaignImg}" width="50%" height="50%">
				<br><br>
			</th:block>
			<textarea cols="60" rows="5" readonly="readonly"
				th:text="${campaign.introduction}"></textarea>
			<h4>제공 내역</h4>
			<textarea cols="60" rows="2" readonly="readonly"
				th:text="${campaign.offerHistory}"></textarea>
			<h4>비고</h4>
			<textarea cols="60" rows="2" readonly="readonly"
				th:text="${campaign.remarks}"></textarea>
			<br> <a th:href=@{getCampaignList}>목록으로</a>
		</div>
		<!-- 본문 영역 End -->

		<!-- 프로필 영역 Start -->
		<div style="float: left; width: 25% ;margin-top: 5%;">
			<p th:text="${campaign.advertisementvo.advertisementname}" />
			<br>신청 기간<br>
			<p th:text="|${#dates.format(campaign.startDate, 'yyyy-MM-dd')} ~ ${#dates.format(campaign.endDate, 'yyyy-MM-dd')}|"></p>
			모집 인원<br>
			<div id="campaignParticipants">
				<p th:text="|${campaign.participants} / ${campaign.recruitment}|"></p>
			</div> 
		
		<th:block th:if="${session[advertisementvo] != null}">
		<input th:if="${session['advertisementvo'].advertisementId} == ${campaign.advertisementvo.advertisementId}" type="button" id="applyBtn" value="응모자 보기">
		</th:block>
		
		<th:block th:if="${session[uservo] != null}">
		
		<input type="hidden" id="userId" th:value="${session['uservo'].userId}">
		<input type="hidden" id="campaignId" th:value="${campaign.campaignId}">
		
		<div id="participantPlus">		
		<input type="button" id="participantPlusBtn" value="응모하기">	
		</div>
		
		<div id="participantMinus">
		<input type="button" id="participantMinusBtn" value="취소하기">
		</div>
		
		</th:block>

    	<!-- The Modal -->
    	<div id="applyModal" class="modal" >
         <!-- Modal content -->
         	<div class="modal-content">
        		<span class="close"></span> 
        		<div id="modalParticipants"></div>                                                            
      		</div> 
    	</div>	
			
    	</div> <!-- 프로필 영역 END -->	
	</div>


	<!-- 모달 스크립트 -->
	<script>
	
	var modal = document.getElementById('applyModal');
	var span = document.getElementsByClassName("close")[0];	
	span.onclick = function() {
	    modal.style.display = "none";
	}	

	window.onclick = function(event) {
	    if (event.target == modal) {
	        modal.style.display = "none";
	    }
	}	
	</script>


	<!-- 응모하기 / 취소하기 스크립트 -->
	<script>
	$(document).ready(function(){
		var userId = $("#userId").val();
		var campaignId = $("#campaignId").val();
		$.ajax({
			url:"/participantsCheck",
			data:{
				userId:userId,
				campaignId:campaignId
			},
			success:function(result){
				if(result==0){
					$("#participantMinus").hide();
					$("#participantPlus").show();
				}else{
					$("#participantPlus").hide();
					$("#participantMinus").show();
				}			
				
			}
		});
		
		$("#participantPlusBtn").click(function(){
			var userId = $("#userId").val();
			var campaignId = $("#campaignId").val();
			$.ajax({
				url:"/participants",
				data:{
					userId:userId,
					campaignId:campaignId
				},
				success:function(participants){
					var str="<p>"+participants.participants+"/"+participants.recruitment+"</p>";
					$("#campaignParticipants p").remove();
					$("#campaignParticipants").html(str);
					$("#participantPlus").hide();
					$("#participantMinus").show();
					
		    		alertify.set('notifier', 'delay', 2);
		        	alertify.set('notifier', 'position', 'bottom-right');
		        	alertify.success('응모가 완료되었습니다.');
				}
			});
		});
		
		$("#participantMinusBtn").click(function(){
			var userId = $("#userId").val();
			var campaignId = $("#campaignId").val();
			$.ajax({
				url:"/deleteParticipants",
				data:{
					userId:userId,
					campaignId:campaignId
				},
				success:function(participants){
					var str="<p>"+participants.participants+"/"+participants.recruitment+"</p>";
					$("#campaignParticipants p").remove();
					$("#campaignParticipants").html(str);
					$("#participantMinus").hide();
					$("#participantPlus").show();
					
					alertify.set('notifier', 'delay', 2);
		        	alertify.set('notifier', 'position', 'bottom-right');
		        	alertify.error('취소가 완료되었습니다.');
				}
			});
		});
	});
	</script>
	
	
	<!-- 선정하기 / 취소하기 스크립트 -->
	<script>
	$(document).ready(function(){
			
		$("#applyBtn").click(function(){
			participant();
			modal.style.display = "block";
		});
		
		$(document).on('click','.selectParticipantBtn',function(){
			var participantsId = $(this).next().val();
			$.ajax({
				url:"/selectParticipant",
				data:{participantsId:participantsId},
				success:function(){
					participant();
					
		    		alertify.set('notifier', 'delay', 2);
		        	alertify.set('notifier', 'position', 'bottom-right');
		        	alertify.success('선정이 완료되었습니다.');
				}
			});
		});
		
		$(document).on('click','.cancelParticipantBtn',function(){
			var participantsId = $(this).next().val();
			$.ajax({
				url:"/cancelParticipant",
				data:{participantsId:participantsId},
				success:function(){
					participant();
					
					alertify.set('notifier', 'delay', 2);
		        	alertify.set('notifier', 'position', 'bottom-right');
		        	alertify.error('선정 취소가 완료되었습니다.');
				}
			});
		});
		
		function participant(){
			var campaignId = $("#campaignId").val();
			$.ajax({
				url:"/selectParticipantList",
				data:{campaignId:campaignId},
				success:function(participantList){
					var str="";
					str += "<table>";
					for(var i in participantList){
						str += "<tr><td>"+participantList[i].nickname+"</td>";
						if(participantList[i].participation=="N"){
							str += "<td><input type='button' class='selectParticipantBtn' style='float: right' value='선정하기'>";
							str += "<input type='hidden' value='"+participantList[i].participantsId+"'></td>"
						}else{
							str += "<td><input type='button' class='cancelParticipantBtn' style='float: right' value='취소하기'>";
							str += "<input type='hidden' value='"+participantList[i].participantsId+"'></td></tr>"
						}
					}
					str += "</table>";
					$("#modalParticipants table").remove;
					$("#modalParticipants").html(str);			
					
				}
			});
		}
	});
	</script>
	
	<!-- 삭제하기 스크립트 -->
	<script>
	$(document).ready(function(){
		$("#deleteTxt").click(function(){
			
			var campaignId = $("#campaignId").val();
			alertify.confirm('', '게시물을 삭제하시겠습니까?',
					function(){ alertify.success('Ok') ,	            	
					location.href="/deleteCampaign?campaignId="+campaignId;
	            }
           ,function(){ 
        	   alertify.set('notifier','delay',2);
        	   alertify.error('취소하였습니다.')});
		});		
	})	
	</script>
</body>
</html>