<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>리뷰 목록</title>
<meta http-equiv="Content-type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="/common/css/styles.css"
   th:href="@{/common/css/styles.css}" type="text/css">
<link rel="stylesheet" href="/common/css/styles.css"
   th:href="@{/common/css/review.css}" type="text/css">
<link rel="stylesheet"
   href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script
   src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
   <div id="wrap" class="main">
      <div th:replace="/include/header.html :: header"></div>

      <div class="reviewWriteForm">
         <form th:action="@{reviewViewUpdate}" method="post">
            <input id="reviewId" name="reviewId" type="hidden"
               th:value="${reviewView.reviewId}"> <input id="userId"
               name="userId" type="hidden" th:value="${reviewView.uservo.userId}">
            <table class="reviewWriteTable">
               <tr>
                  <td style="width: 950px;" colspan="3"><input
                     class="reviewWriteTitle" name="title" type="text"
                     th:value="${reviewView.title}"></td>
               </tr>

               <tr>
                  <td style="width: 350px;" colspan="1"><div class="fileDrop">여기에
                        그림파일을 드래그해주세요</div></td>
                  <td style="width: 600px;" colspan="2"><div
                        class="uploadedList"></div></td>
               </tr>
               <tr>
                  <td style="width: 350px;" colspan="2">
                     <div id="imageListArea" class="beforeUploadedList"></div>
                  </td>
               </tr>

               <tr>
                  <td colspan="3"><textarea class="reviewWriteTextarea"
                        name="advantages" placeholder="장점을 입력해주세요"
                        th:text="${reviewView.advantages}"></textarea></td>
               <tr>
               <tr>
                  <td colspan="3"><textarea class="reviewWriteTextarea"
                        name="disadvantages" placeholder="단점을 입력해주세요"
                        th:text="${reviewView.disadvantages}"></textarea></td>
               <tr>
               <tr>
                  <td></td>
                  <td style="text-align: right;"><span><input
                        class="reviewWriteSubmitBtn" type="submit" value="수정완료"></span><span>
                        <input class="reviewWriteCancleBtn" type="button"
                        th:value="취소하기" onclick="location.href='/doReviewList'">
                  </span></td>
               </tr>
            </table>
         </form>
      </div>
      <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

   <script
      src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
   
   <script>
      $(document).ready(function() {
//          showCommentList();
         showImageList();
         function showImageList() {
            var reviewId = $('#reviewId').val();
            $.ajax({
               url : "/imageList",
               type : "GET",
               data : {
               reviewId : reviewId
               },
               dateType : 'json',
               success : function(data) {
                     var str = "<table>";
                     for ( var i in data) {
                        str += "<div>"
                        str += "<tr><td style='width: 350px;'>";
                        str += "<a href='/displayFile?fileName="+ data[i].img+ "'>";
                        str += "<img style='width: 340px; height: 280px;' src='/displayFile?fileName="+data[i].img+ "'></a>";
                        str += "<input id='img' name='img' type='hidden' value="+ data[i].img + "></td>";
                        str += "<input id='imgId' name='imgId' type='hidden' value="+ data[i].imgId + "></td>";
                        str += "<td><textarea id='imgReview' name='imgReview' class='ReviewModifyImgTagTextarea' name='showImgReview' text="+data[i].imgReview+">"+ data[i].imgReview+"</textarea></td></tr>";
                        str += "<tr><td><span style='cursor: pointer;' data-src="+data[i].img+">[삭제]</span></td></tr>";
                     }
                     str += "</div>"
                     str += "</table>"

                     /*
                     for ( var i in data) {
                     str += "<div id='ajaxImgId'>"
                     str += "<a href='/displayFile?fileName="+ data[i].img+"'>";
                     str += "<img src='/displayFile?fileName="+ data[i].img+ "' width='50%' height='50%'></a>";
                     str += "<input name='showImgSrc' type='hidden' value="+ data[i].img + ">";                     
                     str += "<span style='cursor: pointer;' data-src="+data[i].img+">[삭제]</span>";                     
                     str += "<br>";                     
                     str += "<textarea rows='3' cols='40' name=imgReview' text="+data[i].imgReview+">"+ data[i].imgReview+ "</textarea>";
                     str += "</textarea>";                           
                     str += "<br><br>";                           
                     str += "</div>"                     
                     }
                      */
                     //일반 파일이면 다운로드 링크               
                     //             } else {
                     //                    for(var i in data){
                     //                        str = "<div><a href='/displayFile?FileName="
                     //                           + data[i].img + "'>" + getOriginalName(data[i].img)
                     //                           + "</a>";
                     //                    }
                     //                  }
                     $("#imageListArea div").remove();
                     $("#imageListArea").html(str);
                     },
                     error : function(error) {
                     console.log("에러 : "+ error);
                        }
                     });
                  }
         
//          업로드 했던 원본 이미지 삭제 메소드
         $(".beforeUploadedList").on("click", "span", function(event) {
            alert("업로드 했던 이미지 삭제")
            var that = $(this); // 여기서 this는 클릭한 span태그

//             alert(that);

            $.ajax({
               url : "/uploadedDeleteFile",
               type : "post",
               //data:"fileName="+$(this).attr("data-src") = {fileName:$(this).attr("data-src")}
               //태그 .attr("속성")
               data : {
                  fileName : $(this).attr("data-src")
               }, //json방식
               dataType : "text",
               success : function(result) {
//                   alert(result);
                  if (result == "modifyDeleted") {
                     //클릭한 span태그가 속한 div제거
                     that.parent("div").remove();
                     showImageList();
                  }
               },
               error : function(error) {
                  console.log("에러 : " + error);
               }
            });
         });
      });
         
         
      </script>
      
      <script
         src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
      <script>
         $(document).ready(function() {
            $(".fileDrop").on("dragenter dragover",
               function(event) {
                  event.preventDefault(); //기본 효과를 막음
         });
         //event :JQeury의 이벤트
         //originalEvent :javascript의 이벤트
         $(".fileDrop").on("drop",function(event) {
            event.preventDefault(); //기본효과를 막음
            //드래그된 파일의 정보
            var files = event.originalEvent.dataTransfer.files;
            //첫번째 파일
            var file = files[0];
            //콘솔에서 파일 정보 확인
            console.log(file);
            //ajax로 전달할 폼 객체
            var formData = new FormData();
            //var formDataReviewId = new FormData(); 
            //폼 객체에 파일 추가, append("변수명", 값)
            var reviewId = $('#reviewId').val();
               formData.append("file",file);
               //formData.append("reviewId", reviewId);
               //formDataReviewId.append("reviewId", reviewId);
               $.ajax({
                  type : "post",
                  url : "/modifyUploadAjax/"+ reviewId, // 매핑주소
                  data : formData,
                  //prosessData: true=>get방식, false=> post방식
                  /* dataType : "text", */
                  // contentType : true => application/x-www-form-urlencoded,
                  //false => multipart/form-data
                  processData : false,
                  contentType : false,
                  success : function(data) {
                     var srt = "";
                     //이미지 파일이면 썸네일 이미지 출력
                     if (checkImageType(data)) {
                        str = "<div id='ajaxImgId'><a href='/displayFile?fileName="+ getImageLink(data)
                           + "'>";
                        str += "<img src='/displayFile?fileName="+ data+ "'></a>";
                        str += "<input name='addImgSrc' type='hidden' value="+ data + ">";
                        //일반 파일이면 다운로드 링크               
                     } else {
                        str = "<div><a href='/displayFile?FileName="+ data+ "'>"+ getOriginalName(data)+ "</a>";
                     }
                     //삭제버튼
                        str += "&nbsp;&nbsp;"
                             str += "<textarea class='reviewImgTextare' rows='6' cols='10' name='addImgReview'></textarea>";
                        str += "<span style='cursor: pointer;' data-src="+data+">[삭제]</span></div>";
                        $(".uploadedList").append(str);
                     // <span style='cursor: pointer;' data-src="+data+">[삭제]</span>
                     }

                  });
               });

         $(".uploadedList").on("click","span",function(event) {
//             alert("이미지 삭제")
            var that = $(this); // 여시거 this는 클릭한 span태그
            /* $("#ajaxImgId").find('img').each(function(){
            var ajaxImgId = $(this).attr('src');
            alert(ajaxImgId);
            }); 
            */
            alert(that);
            $.ajax({
               url : "/deleteFile",
               type : "post",
               //data:"fileName="+$(this).attr("data-src") = {fileName:$(this).attr("data-src")}
               //태그 .attr("속성")
               data : {
                  fileName : $(this).attr("data-src"),
                  //ajaxImgId : ajaxImgId
                  }, //json방식
                  dataType : "text",
                  success : function(result) {
                     if (result == "deleted") {
                     //클릭한 span태그가 속한 div제거
                     that.parent("div").remove();
//                      showImageList();
                        }
                     }
                  });
               });

         

            function getOriginalName(fileName) {
            //이미지 파일이면
            if (checkImageType(fileName)) {
               return; //함수 종료         
            }
            //uuid를 제외한 원래 파일 이름을 리턴
            var idx = fileName.insexOf("_") + 1;
               return fileName.substr(idx);
            }

            function getImageLink(fileName) {
            //이미지 파일이 아니면
               if (!checkImageType(fileName)) {
                  return; //함수 종료
               }
            //이미지 파일이면 (썸네일이 아닌 원본 이미지를 가져오기 위해)
            //썸네일 이미지 파일명 - 파일경로+파일명
            var front = fileName.substr(0, 12); //년 원 일 경로 추출
            var end = fileName.substr(14); // 년 월 일 뎡로와 s_를 제거한 원본 파일명을 추출
            console.log(front); // 2019/09/01
            console.log(end);
            //원본 파일명
               return front + end; //디렉토리를 포함한 원본 파일명을 리턴
            }

            function checkImageType(fileName) {
            // i: ignore case(대소문자 무관)
            var pattern = /jpg|gif|png|jpeg/i; //정규식 표현
               return fileName.match(pattern); //규칙이 맞으면  true      
            }
         });
      </script>
   </div>
</body>
</html>